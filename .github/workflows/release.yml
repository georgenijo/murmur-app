name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      - name: Install dependencies
        run: cd app && npm ci

      - name: TypeScript check
        run: cd app && npx tsc --noEmit

      - name: Unit tests
        run: cd app && npm test

  rust:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: swatinem/rust-cache@v2
        with:
          workspaces: app/src-tauri

      - name: Compile check
        run: cd app/src-tauri && cargo check

      - name: Run tests
        run: cd app/src-tauri && cargo test --lib -- --test-threads=1

  release:
    needs: [typecheck, rust]
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: swatinem/rust-cache@v2
        with:
          workspaces: app/src-tauri

      - name: Install frontend dependencies
        run: cd app && npm ci

      - name: Build, sign, and notarize
        id: tauri-build
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MACOSX_DEPLOYMENT_TARGET: "11.0"
          CMAKE_C_FLAGS: "-march=armv8.5-a -mmacosx-version-min=11.0"
          CMAKE_CXX_FLAGS: "-march=armv8.5-a -mmacosx-version-min=11.0"
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          projectPath: app

      - name: Smoke test — verify .app launches
        run: |
          APP=$(find app/src-tauri/target/release/bundle/macos -maxdepth 1 -name "*.app" | head -1)
          BINARY="$APP/Contents/MacOS/$(ls "$APP/Contents/MacOS/" | head -1)"

          echo "=== Verifying bundle exists ==="
          ls -la "$APP/Contents/MacOS/"

          echo "=== Launching binary ==="
          "$BINARY" &
          PID=$!
          echo "Started with PID $PID"

          echo "=== Waiting 5 seconds ==="
          for i in 1 2 3 4 5; do
            sleep 1
            if ! kill -0 "$PID" 2>/dev/null; then
              echo "FAIL: Process died after ${i}s"
              echo "=== Crash logs ==="
              find ~/Library/Logs/DiagnosticReports -name "ui-*" -newer "$BINARY" 2>/dev/null \
                | head -5 | while read -r f; do
                  echo "--- $f ---"
                  cat "$f"
                done
              exit 1
            fi
            echo "  Alive at ${i}s"
          done

          echo "=== Smoke test passed — killing process ==="
          kill "$PID" 2>/dev/null || true
          wait "$PID" 2>/dev/null || true

      - name: Create draft release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --repo "${{ github.repository }}" \
            --title "${{ github.ref_name }}" \
            --generate-notes \
            --draft

      - name: Upload release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ARTIFACTS='${{ steps.tauri-build.outputs.artifactPaths }}'
          echo "Artifacts: $ARTIFACTS"
          echo "$ARTIFACTS" | jq -r '.[]' | while read -r artifact; do
            if [ ! -f "$artifact" ]; then
              echo "Skipping (not a file): $artifact"
              continue
            fi
            echo "Uploading: $artifact"
            gh release upload "${{ github.ref_name }}" "$artifact" \
              --repo "${{ github.repository }}"
          done

      - name: Generate and upload latest.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"

          # Discover the .app.tar.gz artifact and its .sig sibling from build outputs
          ARTIFACTS='${{ steps.tauri-build.outputs.artifactPaths }}'
          TAR_GZ_FILE=$(echo "$ARTIFACTS" | jq -r '.[]' | grep '\.app\.tar\.gz$' | head -1)
          if [ -z "$TAR_GZ_FILE" ] || [ ! -f "$TAR_GZ_FILE" ]; then
            echo "ERROR: No .app.tar.gz artifact found in build outputs"
            echo "Artifacts: $ARTIFACTS"
            exit 1
          fi
          TAR_GZ_BASENAME=$(basename "$TAR_GZ_FILE")
          # Derive platform from runner arch — uname -m returns arm64 on Apple Silicon,
          # map to aarch64 to match Tauri's platform key convention.
          RUNNER_ARCH=$(uname -m)
          [ "$RUNNER_ARCH" = "arm64" ] && RUNNER_ARCH="aarch64"
          PLATFORM="darwin-${RUNNER_ARCH}"

          SIG_FILE="${TAR_GZ_FILE}.sig"
          SIGNATURE=""
          if [ -f "$SIG_FILE" ]; then
            SIGNATURE=$(cat "$SIG_FILE")
          else
            echo "WARNING: No .sig file found at ${SIG_FILE}"
          fi

          TAR_GZ_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/${TAR_GZ_BASENAME}"

          cat > latest.json <<ENDJSON
          {
            "version": "${VERSION}",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "${PLATFORM}": {
                "url": "${TAR_GZ_URL}",
                "signature": "${SIGNATURE}"
              }
            },
            "notes": "See release notes at https://github.com/${{ github.repository }}/releases/tag/${TAG}"
          }
          ENDJSON

          gh release upload "${TAG}" latest.json \
            --repo "${{ github.repository }}" \
            --clobber

      - name: Publish release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release edit "${{ github.ref_name }}" --draft=false --repo "${{ github.repository }}"
