name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: swatinem/rust-cache@v2
        with:
          workspaces: ui/src-tauri

      - name: Install frontend dependencies
        run: cd ui && npm ci

      - name: Build, sign, and notarize
        id: tauri-build
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          projectPath: ui

      - name: Smoke test — verify .app launches
        run: |
          APP="ui/src-tauri/target/release/bundle/macos/Local Dictation.app"
          BINARY="$APP/Contents/MacOS/ui"

          echo "=== Verifying bundle exists ==="
          ls -la "$APP/Contents/MacOS/"

          echo "=== Launching binary ==="
          "$BINARY" &
          PID=$!
          echo "Started with PID $PID"

          echo "=== Waiting 5 seconds ==="
          for i in 1 2 3 4 5; do
            sleep 1
            if ! kill -0 "$PID" 2>/dev/null; then
              echo "FAIL: Process died after ${i}s"
              echo "=== Crash logs ==="
              find ~/Library/Logs/DiagnosticReports -name "ui-*" -newer "$BINARY" 2>/dev/null \
                | head -5 | while read -r f; do
                  echo "--- $f ---"
                  cat "$f"
                done
              exit 1
            fi
            echo "  Alive at ${i}s"
          done

          echo "=== Smoke test passed — killing process ==="
          kill "$PID" 2>/dev/null || true
          wait "$PID" 2>/dev/null || true

      - name: Create draft release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --repo "${{ github.repository }}" \
            --title "${{ github.ref_name }}" \
            --generate-notes \
            --draft

      - name: Upload release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ARTIFACTS='${{ steps.tauri-build.outputs.artifactPaths }}'
          echo "Artifacts: $ARTIFACTS"
          echo "$ARTIFACTS" | jq -r '.[]' | while read -r artifact; do
            echo "Uploading: $artifact"
            gh release upload "${{ github.ref_name }}" "$artifact" \
              --repo "${{ github.repository }}"
          done

      - name: Publish release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release edit "${{ github.ref_name }}" --draft=false --repo "${{ github.repository }}"
